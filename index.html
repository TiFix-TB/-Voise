<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VoiseTiFi - Умный бюджет</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<style>
    /* ==================== RESET & BASE ==================== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

:root {
    /* Colors */
    --primary: #667eea;
    --primary-dark: #5568d3;
    --secondary: #764ba2;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    
    /* Backgrounds */
    --bg-primary: #0f0f23;
    --bg-secondary: #1a1a2e;
    --bg-card: rgba(26, 26, 46, 0.8);
    --bg-glass: rgba(255, 255, 255, 0.05);
    
    /* Text */
    --text-primary: #ffffff;
    --text-secondary: #a0a0c0;
    --text-muted: #6b7280;
    
    /* Borders */
    --border-color: rgba(255, 255, 255, 0.1);
    --border-radius: 16px;
    --border-radius-small: 12px;
    --border-radius-large: 24px;
    
    /* Shadows */
    --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.1);
    --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.2);
    --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.3);
    --shadow-glow: 0 0 20px rgba(102, 126, 234, 0.3);
    
    /* Gradients */
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    --gradient-info: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    
    /* Spacing */
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;
    
    /* Transitions */
    --transition-fast: 0.2s ease;
    --transition-normal: 0.3s ease;
    --transition-slow: 0.5s ease;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

/* ==================== LOADING SCREEN ==================== */

/* ==================== ONBOARDING ==================== */
#onboarding {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: var(--bg-primary);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-lg);
}

#onboarding.active {
    display: flex;
}

.onboarding-content {
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.onboarding-logo {
    margin-bottom: var(--spacing-xl);
    animation: fadeInUp 0.6s ease;
}

.logo-icon {
    font-size: 80px;
    margin-bottom: var(--spacing-md);
    animation: bounce 2s infinite;
}

.onboarding-logo h1 {
    font-size: 36px;
    font-weight: 800;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--spacing-sm);
}

.onboarding-logo p {
    color: var(--text-secondary);
    font-size: 16px;
}

.onboarding-step {
    display: none;
    animation: fadeInUp 0.4s ease;
}

.onboarding-step.active {
    display: block;
}

.onboarding-step h2 {
    font-size: 28px;
    margin-bottom: var(--spacing-md);
}

.onboarding-step p {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xl);
    font-size: 16px;
}

.income-input-wrapper {
    margin-bottom: var(--spacing-xl);
}

.big-input {
    width: 100%;
    font-size: 48px;
    font-weight: 700;
    text-align: center;
    background: var(--bg-glass);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
    backdrop-filter: blur(10px);
}

.big-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--shadow-glow);
}

.currency-selector {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: center;
}

.currency-btn,
.lang-btn {
    flex: 1;
    padding: var(--spacing-md);
    background: var(--bg-glass);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius-small);
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    backdrop-filter: blur(10px);
}

.currency-btn:hover,
.lang-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.currency-btn.active,
.lang-btn.active {
    background: var(--gradient-primary);
    border-color: var(--primary);
    box-shadow: var(--shadow-glow);
}

.language-selector {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.btn-primary {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--gradient-primary);
    border: none;
    border-radius: var(--border-radius);
    color: white;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-medium);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-large);
}

.btn-primary:active {
    transform: translateY(0);
}

/* ==================== APP CONTAINER ==================== */
.app-container {
    position: relative;
    max-width: 680px;
    min-width: 360px;
    margin: 0 auto;
    height: 100vh;
    background: var(--bg-primary);
    overflow: hidden;
    z-index: 1;
}

.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: calc(100vh - 80px);
    overflow-y: auto;
    overflow-x: hidden;
    opacity: 0;
    transform: translateX(100%);
    transition: all var(--transition-normal);
    pointer-events: none;
    padding-bottom: var(--spacing-xl);
}

.screen.active {
    opacity: 1;
    transform: translateX(0);
    pointer-events: all;
}

.screen-content {
    padding: var(--spacing-md);
}

/* Custom Scrollbar */
.screen::-webkit-scrollbar {
    width: 4px;
}

.screen::-webkit-scrollbar-track {
    background: transparent;
}

.screen::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

/* ==================== HEADERS ==================== */
.app-header {
    padding: var(--spacing-lg) var(--spacing-md) var(--spacing-md);
    background: var(--bg-primary);
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(20px);
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.greeting h3 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: var(--spacing-xs);
}

.greeting p {
    font-size: 14px;
    color: var(--text-secondary);
}

.notification-btn {
    position: relative;
    width: 48px;
    height: 48px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    transition: all var(--transition-fast);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
}

.notification-btn:active {
    transform: scale(0.95);
}

.notification-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    background: var(--danger);
    border-radius: 50%;
    font-size: 12px;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--bg-primary);
}

.screen-header {
    padding: var(--spacing-lg) var(--spacing-md);
    background: var(--bg-primary);
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
}

.screen-header h2 {
    font-size: 24px;
    font-weight: 700;
}

/* ==================== BALANCE CARD ==================== */
.balance-card {
    background: var(--gradient-primary);
    border-radius: var(--border-radius-large);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    box-shadow: var(--shadow-large);
    animation: fadeInUp 0.4s ease;
    position: relative;
    overflow: hidden;
}

.balance-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: rotate 20s linear infinite;
}

.balance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
    position: relative;
    z-index: 1;
}

.balance-header span {
    font-size: 14px;
    opacity: 0.9;
    font-weight: 500;
}

.edit-btn {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    font-size: 16px;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.edit-btn:active {
    transform: scale(0.9);
}

.balance-amount {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: var(--spacing-md);
    position: relative;
    z-index: 1;
}

.balance-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    position: relative;
    z-index: 1;
}

.stat {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.stat-label {
    font-size: 12px;
    opacity: 0.8;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
}

.stat-value.positive {
    color: #86efac;
}

.stat-value.negative {
    color: #fca5a5;
}

.progress-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 999px;
    overflow: hidden;
    margin-bottom: var(--spacing-sm);
    position: relative;
    z-index: 1;
}

.progress-fill {
    height: 100%;
    background: white;
    border-radius: 999px;
    transition: width var(--transition-slow);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

.progress-text {
    font-size: 12px;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

/* ==================== QUICK STATS ==================== */
.quick-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
}

.stat-card {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
    transition: all var(--transition-fast);
    animation: fadeInUp 0.4s ease;
    animation-fill-mode: both;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }

.stat-card:active {
    transform: scale(0.95);
}

.stat-icon {
    font-size: 24px;
}

.stat-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
}

.stat-info .stat-label {
    font-size: 11px;
    color: var(--text-secondary);
}

.stat-info .stat-value {
    font-size: 16px;
    font-weight: 700;
}

/* ==================== SECTION HEADER ==================== */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.section-header h3 {
    font-size: 18px;
    font-weight: 700;
}

.view-all-btn {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}

/* ==================== QUICK ACTIONS ==================== */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    animation: fadeInUp 0.4s ease;
    animation-fill-mode: both;
}

.action-btn:nth-child(1) { animation-delay: 0.1s; }
.action-btn:nth-child(2) { animation-delay: 0.2s; }
.action-btn:nth-child(3) { animation-delay: 0.3s; }
.action-btn:nth-child(4) { animation-delay: 0.4s; }

.action-btn:active {
    transform: scale(0.95);
}

.action-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all var(--transition-fast);
}

.action-icon.voice {
    background: var(--gradient-primary);
    animation: pulse 2s infinite;
}

.action-icon.receipt {
    background: var(--gradient-info);
}

.action-icon.income {
    background: var(--gradient-success);
}

.action-icon.expense {
    background: var(--gradient-danger);
}

.action-btn span {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}

/* ==================== ALERTS ==================== */
.alerts-container {
    margin-bottom: var(--spacing-lg);
}

.alert {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid;
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    animation: slideInRight 0.4s ease;
}

.alert.warning {
    border-color: var(--warning);
}

.alert.danger {
    border-color: var(--danger);
}

.alert.info {
    border-color: var(--info);
}

.alert-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.alert-content {
    flex: 1;
}

.alert-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
}

.alert-text {
    font-size: 12px;
    color: var(--text-secondary);
}

/* ==================== TRANSACTIONS LIST ==================== */
.transactions-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.transaction-group {
    margin-bottom: var(--spacing-md);
}

.transaction-date-header {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
    padding: 0 var(--spacing-xs);
}

.transaction-item {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
}

.transaction-item:active {
    transform: scale(0.98);
}

.transaction-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
}

.transaction-info {
    flex: 1;
    min-width: 0;
}

.transaction-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.transaction-time {
    font-size: 12px;
    color: var(--text-secondary);
}

.transaction-amount {
    font-size: 18px;
    font-weight: 700;
    flex-shrink: 0;
}

.transaction-receipt {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius-small);
    object-fit: cover;
    border: 1px solid var(--border-color);
}

/* ==================== ANALYTICS ==================== */
.period-selector {
    display: flex;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: var(--spacing-lg);
    overflow-x: auto;
}

.period-btn {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    border: none;
    border-radius: var(--border-radius-small);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
}

.period-btn.active {
    background: var(--gradient-primary);
    color: white;
}

.analytics-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.analytics-card {
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    color: white;
    box-shadow: var(--shadow-medium);
    animation: fadeInUp 0.4s ease;
    animation-fill-mode: both;
}

.analytics-card:nth-child(1) { animation-delay: 0.1s; }
.analytics-card:nth-child(2) { animation-delay: 0.2s; }
.analytics-card:nth-child(3) { animation-delay: 0.3s; }
.analytics-card:nth-child(4) { animation-delay: 0.4s; }

.analytics-card.green { background: var(--gradient-success); }
.analytics-card.red { background: var(--gradient-danger); }
.analytics-card.purple { background: var(--gradient-primary); }
.analytics-card.blue { background: var(--gradient-info); }

.card-label {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: var(--spacing-sm);
}

.card-value {
    font-size: 28px;
    font-weight: 800;
}

.chart-container {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.chart-container h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: var(--spacing-lg);
}

.comparison-card {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.comparison-card h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: var(--spacing-md);
}

.comparison-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--border-color);
}

.comparison-item:last-child {
    border-bottom: none;
}

.comparison-value {
    font-weight: 700;
}

.comparison-value.positive {
    color: var(--success);
}

.comparison-value.negative {
    color: var(--danger);
}

/* ==================== FILTERS ==================== */
.search-container {
    margin-bottom: var(--spacing-md);
}

.search-input {
    width: 100%;
    padding: var(--spacing-md);
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 15px;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary);
}

.filters-container {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
}

.filter-select {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 14px;
}

.filter-btn {
    width: 48px;
    height: 48px;
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 20px;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
}

.filter-btn:active {
    transform: scale(0.95);
}

.period-totals {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin-top: var(--spacing-lg);
}

.total-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
}

.total-item.total-balance {
    border-top: 2px solid var(--border-color);
    padding-top: var(--spacing-md);
    margin-top: var(--spacing-sm);
    font-weight: 700;
    font-size: 18px;
}

/* ==================== SETTINGS ==================== */
.settings-section {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
}

.section-title {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-fast);
    background: none;
    border-left: none;
    border-right: none;
    border-top: none;
    width: 100%;
    text-align: left;
    color: var(--text-primary);
    font-size: 15px;
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-item:active {
    opacity: 0.7;
}

.setting-value {
    color: var(--text-secondary);
    font-size: 14px;
}
.settings-btn {
    width: 100%;
    padding: var(--spacing-md);
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-small);
    color: var(--text-primary);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: var(--spacing-sm);
}

.settings-btn:last-child {
    margin-bottom: 0;
}

.settings-btn:active {
    transform: scale(0.98);
}

.settings-btn.danger {
    color: var(--danger);
    border-color: var(--danger);
}

/* Toggle Switch */
.toggle-item {
    cursor: default;
}

.toggle {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
}

.toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    transition: var(--transition-normal);
    border-radius: 999px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 3px;
    background: var(--text-secondary);
    transition: var(--transition-normal);
    border-radius: 50%;
}

.toggle input:checked + .toggle-slider {
    background: var(--gradient-primary);
    border-color: var(--primary);
}

.toggle input:checked + .toggle-slider:before {
    transform: translateX(24px);
    background: white;
}

/* ==================== BOTTOM NAVIGATION ==================== */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 680px;
    min-width: 360px;
    height: 80px;
    background: var(--bg-secondary);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 0 var(--spacing-md);
    z-index: 100;
}

.nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    padding: var(--spacing-sm);
    border-radius: var(--border-radius-small);
    min-width: 60px;
}

.nav-btn:active {
    transform: scale(0.95);
}

.nav-btn.active {
    color: var(--primary);
}

.nav-btn.active .nav-icon {
    transform: scale(1.1);
}

.nav-icon {
    font-size: 24px;
    transition: all var(--transition-fast);
}

.nav-label {
    font-size: 11px;
    font-weight: 600;
}

.add-btn {
    width: 64px;
    height: 64px;
    background: var(--gradient-primary);
    border-radius: 50%;
    margin-top: -32px;
    box-shadow: var(--shadow-large);
    animation: pulse 2s infinite;
}

.add-btn .nav-icon {
    font-size: 32px;
    color: white;
}

.add-btn:active {
    transform: scale(0.9);
}

/* ==================== MODALS ==================== */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    display: none;
    align-items: flex-end;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal.active {
    display: flex;
}

.modal-content {
    width: 100%;
    max-width: 680px;
    background: var(--bg-secondary);
    border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
    padding: var(--spacing-lg);
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}

.modal-content.modal-center {
    border-radius: var(--border-radius-large);
    max-height: 80vh;
    margin: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.modal-header h3 {
    font-size: 20px;
    font-weight: 700;
}

.modal-close {
    width: 32px;
    height: 32px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    font-size: 20px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:active {
    transform: scale(0.9);
}

.modal-tabs {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    overflow-x: auto;
    padding-bottom: var(--spacing-sm);
}

.modal-tab {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-small);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
}

.modal-tab.active {
    background: var(--gradient-primary);
    color: white;
    border-color: var(--primary);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

/* ==================== CATEGORIES GRID ==================== */
.categories-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.category-item {
    background: var(--bg-glass);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.category-item:active {
    transform: scale(0.95);
}

.category-item.active {
    border-color: var(--primary);
    background: var(--gradient-primary);
}

.category-item.active .category-label {
    color: white;
}

.category-icon {
    font-size: 32px;
}

.category-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-align: center;
}

/* ==================== FORM INPUTS ==================== */
.amount-input {
    margin-bottom: var(--spacing-lg);
}

.amount-field {
    width: 100%;
    font-size: 48px;
    font-weight: 700;
    text-align: center;
    background: var(--bg-glass);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    color: var(--text-primary);
}

.amount-field:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--shadow-glow);
}

.desc-input,
.select-input {
    width: 100%;
    padding: var(--spacing-md);
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-small);
    color: var(--text-primary);
    font-size: 15px;
    margin-bottom: var(--spacing-md);
}

.desc-input:focus,
.select-input:focus {
    outline: none;
    border-color: var(--primary);
}

.attach-btn {
    width: 100%;
    padding: var(--spacing-md);
    background: var(--bg-glass);
    border: 2px dashed var(--border-color);
    border-radius: var(--border-radius-small);
    color: var(--text-secondary);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: var(--spacing-md);
}

.attach-btn:active {
    transform: scale(0.98);
}

.btn-large {
    padding: var(--spacing-lg);
    font-size: 18px;
}

/* ==================== VOICE MODAL ==================== */
.voice-animation {
    position: relative;
    width: 120px;
    height: 120px;
    margin: var(--spacing-xl) auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.voice-circle {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--gradient-primary);
    opacity: 0.3;
    animation: voicePulse 1.5s infinite;
}

.voice-icon {
    font-size: 48px;
    z-index: 1;
}

#voice-status {
    text-align: center;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
}

#voice-text {
    text-align: center;
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xl);
    min-height: 50px;
}

/* ==================== TOP CATEGORIES ==================== */
.category-bar {
    margin-bottom: var(--spacing-md);
}

.category-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.category-bar-name {
    font-size: 14px;
    font-weight: 600;
}

.category-bar-value {
    font-size: 14px;
    color: var(--text-secondary);
}

.category-bar-progress {
    height: 8px;
    background: var(--bg-glass);
    border-radius: 999px;
    overflow: hidden;
}

.category-bar-fill {
    height: 100%;
    border-radius: 999px;
    transition: width var(--transition-slow);
}

/* ==================== CALENDAR HEATMAP ==================== */
#calendar-heatmap {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: var(--spacing-xs);
}

.calendar-day {
    aspect-ratio: 1;
    border-radius: var(--border-radius-small);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.calendar-day:active {
    transform: scale(0.9);
}

.calendar-day.empty {
    opacity: 0.3;
}

/* ==================== RECEIPT PREVIEW ==================== */
.receipt-preview {
    margin-top: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    text-align: center;
}

.receipt-thumbnail {
    width: 100%;
    max-width: 200px;
    border-radius: var(--border-radius);
    border: 2px solid var(--border-color);
}

/* ==================== ANIMATIONS ==================== */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }
    to {
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
    }
    50% {
        box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
    }
}

@keyframes voicePulse {
    0%, 100% {
        transform: scale(1);
        opacity: 0.3;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.1;
    }
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

@keyframes rotate {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ==================== LOADING STATES ==================== */
.skeleton {
    background: linear-gradient(90deg, var(--bg-glass) 25%, rgba(255,255,255,0.1) 50%, var(--bg-glass) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: var(--border-radius);
}

@keyframes shimmer {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* ==================== EMPTY STATES ==================== */
.empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
}

.empty-state-text {
    font-size: 16px;
    margin-bottom: var(--spacing-md);
}

/* ==================== LIGHT THEME ==================== */
body.light {
    --bg-primary: #f5f7fa;
    --bg-secondary: #ffffff;
    --bg-card: rgba(255, 255, 255, 0.9);
    --bg-glass: rgba(0, 0, 0, 0.05);
    --text-primary: #1a1a2e;
    --text-secondary: #6b7280;
    --border-color: rgba(0, 0, 0, 0.1);
}

body.light::before {
    background: radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
}

/* ==================== SAFE AREAS (iOS) ==================== */
@supports (padding: max(0px)) {
    .app-header {
        padding-top: max(var(--spacing-lg), env(safe-area-inset-top));
    }
    
    .bottom-nav {
        padding-bottom: max(0px, env(safe-area-inset-bottom));
        height: calc(80px + env(safe-area-inset-bottom));
    }
    
    .screen {
        height: calc(100vh - 80px - env(safe-area-inset-bottom));
    }
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 400px) {
    .quick-stats {
        grid-template-columns: 1fr;
    }
    
    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .analytics-cards {
        grid-template-columns: 1fr;
    }
    
    .categories-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .balance-amount {
        font-size: 36px;
    }
    
    .amount-field,
    .big-input {
        font-size: 36px;
    }
}

@media (max-width: 360px) {
    .quick-actions {
        gap: var(--spacing-sm);
    }
    
    .action-btn {
        padding: var(--spacing-sm);
    }
    
    .action-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    .nav-label {
        font-size: 10px;
    }
}

/* ==================== PRINT STYLES ==================== */
@media print {
    .bottom-nav,
    .notification-btn,
    .edit-btn,
    .modal,
    .quick-actions,
    .add-btn {
        display: none !important;
    }
    
    .screen {
        position: static;
        height: auto;
        overflow: visible;
    }
    
    .app-container {
        max-width: 100%;
        height: auto;
    }
}

/* ==================== ACCESSIBILITY ==================== */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ==================== HIGH CONTRAST MODE ==================== */
@media (prefers-contrast: high) {
    :root {
        --border-color: rgba(255, 255, 255, 0.3);
        --text-secondary: #d0d0d0;
    }
    
    body.light {
        --border-color: rgba(0, 0, 0, 0.3);
        --text-secondary: #404040;
    }
}

/* ==================== FOCUS STYLES ==================== */
button:focus-visible,
input:focus-visible,
select:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* ==================== SCROLLBAR STYLING (Firefox) ==================== */
* {
    scrollbar-width: thin;
    scrollbar-color: var(--border-color) transparent;
}
</style>
<body>
    <!-- ONBOARDING SCREEN -->
    <div id="onboarding" class="screen" style="display:none;">
        <div class="onboarding-content">
            <div class="onboarding-logo">
                <div class="logo-icon" aria-label="Иконка приложения">&#128176;</div>
                <h1>VoiseTiFi</h1>
                <p>Умное управление финансами</p>
            </div>
            
            <!-- STEP 1: Welcome -->
            <div class="onboarding-step active" data-step="1">
                <h2>Добро пожаловать!</h2>
                <p>Давайте настроим ваш бюджет</p>
                <button class="btn-primary" onclick="nextOnboardingStep()" aria-label="Начать настройку">
                    Начать
                </button>
            </div>

            <!-- STEP 2: Income -->
            <div class="onboarding-step" data-step="2">
                <h2>Ваш ежемесячный доход</h2>
                <div class="income-input-wrapper">
                    <input 
                        type="number" 
                        id="monthly-income" 
                        placeholder="0" 
                        class="big-input"
                        min="0"
                        step="0.01"
                        aria-label="Ежемесячный доход"
                        required>
                    <div class="currency-selector" role="group" aria-label="Выбор валюты">
                        <button class="currency-btn active" 
                                data-currency="USD" 
                                data-rate="1" 
                                data-symbol="$"
                                aria-pressed="true">
                            $ USD
                        </button>
                        <button class="currency-btn" 
                                data-currency="TJS" 
                                data-rate="10.7" 
                                data-symbol="SM"
                                aria-pressed="false">
                            SM TJS
                        </button>
                        <button class="currency-btn" 
                                data-currency="RUB" 
                                data-rate="92" 
                                data-symbol="&#8381;"
                                aria-pressed="false">
                            &#8381; RUB
                        </button>
                    </div>
                </div>
                <button class="btn-primary" onclick="nextOnboardingStep()" aria-label="Продолжить">
                    Продолжить
                </button>
            </div>

            <!-- STEP 3: Language -->
            <div class="onboarding-step" data-step="3">
                <h2>Выберите язык</h2>
                <div class="language-selector" role="group" aria-label="Выбор языка">
                    <button class="lang-btn active" 
                            data-lang="ru"
                            aria-pressed="true">
                        Русский
                    </button>
                    <button class="lang-btn" 
                            data-lang="en"
                            aria-pressed="false">
                        English
                    </button>
                    <button class="lang-btn" 
                            data-lang="tj"
                            aria-pressed="false">
                        Тоҷикӣ
                    </button>
                </div>
                <button class="btn-primary" onclick="finishOnboarding()" aria-label="Завершить настройку">
                    Готово!
                </button>
            </div>
        </div>
    </div>
    <!-- MAIN APP -->
    <div id="app" class="app-container" style="display:none;">
        <!-- HOME SCREEN -->
        <div id="home-screen" class="screen active">
            <header class="app-header">
                <div class="header-top">
                    <div class="greeting">
                        <h3 id="greeting-text">Добрый день</h3>
                        <p id="current-date">Понедельник, 13 октября</p>
                    </div>
                    <button class="notification-btn" 
                            onclick="showNotifications()"
                            aria-label="Уведомления">
                        <span class="notification-badge" aria-label="2 новых уведомления">2</span>
                        <span aria-hidden="true">&#128276;</span>
                    </button>
                </div>
            </header>

            <div class="screen-content">
                <!-- MAIN BALANCE CARD -->
                <div class="balance-card">
                    <div class="balance-header">
                        <span>Ваш бюджет</span>
                        <button class="edit-btn" 
                                onclick="editBudget()"
                                aria-label="Редактировать бюджет">
                            &#9998;&#65039;
                        </button>
                    </div>
                    <div class="balance-amount" id="total-balance" aria-live="polite">$0</div>
                    <div class="balance-stats">
                        <div class="stat">
                            <span class="stat-label">Доход</span>
                            <span class="stat-value positive" id="total-income" aria-live="polite">+$0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Расход</span>
                            <span class="stat-value negative" id="total-expense" aria-live="polite">-$0</span>
                        </div>
                    </div>
                    <div class="progress-bar" role="progressbar" aria-label="Прогресс бюджета">
                        <div class="progress-fill" id="budget-progress" style="width: 0%"></div>
                    </div>
                    <p class="progress-text">
                        Потрачено <span id="spent-percent">0%</span> от бюджета
                    </p>
                </div>

                <!-- QUICK STATS -->
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-icon" aria-hidden="true">&#128197;</div>
                        <div class="stat-info">
                            <span class="stat-label">Сегодня</span>
                            <span class="stat-value" id="today-spent">-$0</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" aria-hidden="true">&#128202;</div>
                        <div class="stat-info">
                            <span class="stat-label">Неделя</span>
                            <span class="stat-value" id="week-spent">-$0</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" aria-hidden="true">&#128200;</div>
                        <div class="stat-info">
                            <span class="stat-label">Месяц</span>
                            <span class="stat-value" id="month-spent">-$0</span>
                        </div>
                    </div>
                </div>

                <!-- QUICK ACTIONS -->
                <div class="section-header">
                    <h3>Быстрые действия</h3>
                </div>
                <div class="quick-actions">
                    <button class="action-btn" onclick="openVoiceInput()" aria-label="Голосовой ввод">
                        <div class="action-icon voice" aria-hidden="true">&#127908;</div>
                        <span>Голос</span>
                    </button>
                    <button class="action-btn" onclick="openAddWithReceipt()" aria-label="Добавить с чеком">
                        <div class="action-icon receipt" aria-hidden="true">&#128444;&#65039;</div>
                        <span>С чеком</span>
                    </button>
                    <button class="action-btn" onclick="openAddIncome()" aria-label="Добавить доход">
                        <div class="action-icon income" aria-hidden="true">&#128176;</div>
                        <span>Доход</span>
                    </button>
                    <button class="action-btn" onclick="openAddExpense()" aria-label="Добавить расход">
                        <div class="action-icon expense" aria-hidden="true">&#128179;</div>
                        <span>Расход</span>
                    </button>
                </div>

                <!-- ALERTS -->
                <div id="alerts-container" class="alerts-container" role="alert" aria-live="polite">
                    <!-- Динамические алерты -->
                </div>

                <!-- RECENT TRANSACTIONS -->
                <div class="section-header">
                    <h3>Последние операции</h3>
                    <button class="view-all-btn" onclick="switchScreen('history')" aria-label="Посмотреть все операции">
                        Все &#8594;
                    </button>
                </div>
                <div class="transactions-list" id="recent-transactions">
                    <!-- Динамический контент -->
                </div>
            </div>
        </div>

        <!-- ANALYTICS SCREEN -->
        <div id="analytics-screen" class="screen">
            <header class="screen-header">
                <h2>&#128202; Аналитика</h2>
            </header>

            <div class="screen-content">
                <!-- PERIOD SELECTOR -->
                <div class="period-selector" id="period-tabs" role="tablist" aria-label="Выбор периода">
                    <button class="period-btn" 
                            data-period="today" 
                            role="tab"
                            aria-selected="false">
                        Сегодня
                    </button>
                    <button class="period-btn active" 
                            data-period="week"
                            role="tab"
                            aria-selected="true">
                        Неделя
                    </button>
                    <button class="period-btn" 
                            data-period="month"
                            role="tab"
                            aria-selected="false">
                        Месяц
                    </button>
                    <button class="period-btn" 
                            data-period="year"
                            role="tab"
                            aria-selected="false">
                        Год
                    </button>
                </div>

                <!-- STATS CARDS -->
                <div class="analytics-cards">
                    <div class="analytics-card green">
                        <div class="card-label">Доход</div>
                        <div class="card-value" id="analytics-income">+$0</div>
                    </div>
                    <div class="analytics-card red">
                        <div class="card-label">Расход</div>
                        <div class="card-value" id="analytics-expense">-$0</div>
                    </div>
                    <div class="analytics-card purple">
                        <div class="card-label">Баланс</div>
                        <div class="card-value" id="analytics-balance">$0</div>
                    </div>
                    <div class="analytics-card blue">
                        <div class="card-label">В день</div>
                        <div class="card-value" id="analytics-daily">-$0</div>
                    </div>
                </div>

                <!-- LINE CHART -->
                <div class="chart-container">
                    <h3>Динамика расходов</h3>
                    <canvas id="line-chart" aria-label="График динамики расходов"></canvas>
                </div>

                <!-- PIE CHART -->
                <div class="chart-container">
                    <h3>Структура расходов</h3>
                    <canvas id="pie-chart" aria-label="Круговая диаграмма расходов"></canvas>
                </div>

                <!-- TOP CATEGORIES -->
                <div class="chart-container">
                    <h3>Топ категорий</h3>
                    <div id="top-categories">
                        <!-- Динамический контент -->
                    </div>
                </div>

                <!-- COMPARISON -->
                <div class="comparison-card">
                    <h3>Сравнение с прошлым месяцем</h3>
                    <div class="comparison-item">
                        <span>Расходы</span>
                        <span class="comparison-value positive">&#8595; 15%</span>
                    </div>
                    <div class="comparison-item">
                        <span>Доходы</span>
                        <span class="comparison-value positive">&#8593; 8%</span>
                    </div>
                </div>

                <!-- CALENDAR HEATMAP -->
                <div class="chart-container">
                    <h3>Календарь расходов</h3>
                    <div id="calendar-heatmap" role="grid" aria-label="Календарь расходов">
                        <!-- Динамический контент -->
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY SCREEN -->
        <div id="history-screen" class="screen">
            <header class="screen-header">
                <h2>&#128220; История</h2>
            </header>

            <div class="screen-content">
                <!-- SEARCH AND FILTERS -->
                <div class="search-container">
                    <input type="text" 
                           id="search-input" 
                           placeholder="&#128269; Поиск..." 
                           class="search-input"
                           aria-label="Поиск транзакций">
                </div>

                <div class="filters-container">
                    <select id="type-filter" class="filter-select" aria-label="Фильтр по типу">
                        <option value="all">Все типы</option>
                        <option value="expense">Расходы</option>
                        <option value="income">Доходы</option>
                        <option value="transfer">Переводы</option>
                    </select>
                    <select id="category-filter" class="filter-select" aria-label="Фильтр по категории">
                        <option value="all">Все категории</option>
                    </select>
                    <button class="filter-btn" 
                            onclick="openDateFilter()"
                            aria-label="Фильтр по дате">
                        &#128197;
                    </button>
                </div>

                <!-- TRANSACTIONS LIST -->
                <div id="transactions-list" class="transactions-list">
                    <!-- Динамический контент -->
                </div>

                <!-- PERIOD TOTALS -->
                <div class="period-totals">
                    <div class="total-item">
                        <span>Доходы:</span>
                        <span class="positive" id="period-income">+$0</span>
                    </div>
                    <div class="total-item">
                        <span>Расходы:</span>
                        <span class="negative" id="period-expenses">-$0</span>
                    </div>
                    <div class="total-item total-balance">
                        <span>Баланс:</span>
                        <span id="period-balance">$0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS SCREEN -->
        <div id="settings-screen" class="screen">
            <header class="screen-header">
                <h2>&#9881;&#65039; Настройки</h2>
            </header>

            <div class="screen-content">
                <!-- PROFILE SECTION -->
                <div class="settings-section">
                    <h3 class="section-title">Профиль и бюджет</h3>
                    <button class="setting-item" onclick="editMonthlyIncome()">
                        <span>Ежемесячный доход</span>
                        <span class="setting-value" id="settings-income">$0</span>
                    </button>
                    <div class="setting-item">
                        <span>Дневной лимит</span>
                        <span class="setting-value" id="daily-limit">$0</span>
                    </div>
                    <div class="setting-item toggle-item">
                        <span>Уведомления о лимитах</span>
                        <label class="toggle">
                            <input type="checkbox" id="limit-notifications" checked aria-label="Включить уведомления о лимитах">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- APPEARANCE -->
                <div class="settings-section">
                    <h3 class="section-title">Внешний вид</h3>
                    <div class="setting-item toggle-item">
                        <span>Тёмная тема</span>
                        <label class="toggle">
                            <input type="checkbox" id="dark-theme" checked aria-label="Включить тёмную тему">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="setting-item" onclick="openLanguageSelector()">
                        <span>Язык</span>
                        <span class="setting-value" id="current-language">Русский</span>
                    </button>
                    <button class="setting-item" onclick="openCurrencySelector()">
                        <span>Валюта</span>
                        <span class="setting-value" id="current-currency">USD $</span>
                    </button>
                </div>

                <!-- CATEGORIES -->
                <div class="settings-section">
                    <h3 class="section-title">Категории</h3>
                    <button class="settings-btn" onclick="manageCategories()">
                        Управление категориями &#8594;
                    </button>
                </div>

                <!-- LOANS -->
                <div class="settings-section">
                    <h3 class="section-title">Кредиты и долги</h3>
                    <button class="settings-btn" onclick="manageLoans()">
                        Управление долгами &#8594;
                    </button>
                </div>

                <!-- RECURRING PAYMENTS -->
                <div class="settings-section">
                    <h3 class="section-title">Повторяющиеся платежи</h3>
                    <button class="settings-btn" onclick="manageRecurring()">
                        Управление платежами &#8594;
                    </button>
                </div>

                <!-- GOALS -->
                <div class="settings-section">
                    <h3 class="section-title">Финансовые цели</h3>
                    <button class="settings-btn" onclick="manageGoals()">
                        Управление целями &#8594;
                    </button>
                </div>

                <!-- BACKUP -->
                <div class="settings-section">
                    <h3 class="section-title">Резервные копии</h3>
                    <button class="settings-btn" onclick="exportData()">
                        &#128228; Экспорт данных
                    </button>
                    <label for="import-file" class="settings-btn" style="cursor:pointer;">
                        &#128229; Импорт данных
                    </label>
                    <input type="file" id="import-file" accept=".json" style="display:none" aria-label="Импортировать данные">
                    <button class="settings-btn danger" onclick="clearAllData()">
                        &#128465;&#65039; Очистить все данные
                    </button>
                </div>

                <!-- NOTIFICATIONS -->
                <div class="settings-section">
                    <h3 class="section-title">Уведомления</h3>
                    <div class="setting-item toggle-item">
                        <span>Превышение бюджета</span>
                        <label class="toggle">
                            <input type="checkbox" id="budget-notifications" checked aria-label="Уведомления о превышении бюджета">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item toggle-item">
                        <span>Напоминания о долгах</span>
                        <label class="toggle">
                            <input type="checkbox" id="debt-notifications" checked aria-label="Напоминания о долгах">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item toggle-item">
                        <span>Еженедельный отчёт</span>
                        <label class="toggle">
                            <input type="checkbox" id="weekly-report" aria-label="Еженедельный отчёт">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- ABOUT -->
                <div class="settings-section">
                    <h3 class="section-title">О приложении</h3>
                    <div class="setting-item">
                        <span>Версия</span>
                        <span class="setting-value">1.0.0</span>
                    </div>
                    <button class="settings-btn" onclick="openAbout()">
                        Информация &#8594;
                    </button>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <nav class="bottom-nav" role="navigation" aria-label="Главное меню">
            <button class="nav-btn active" 
                    data-screen="home" 
                    onclick="switchScreen('home')"
                    aria-label="Главная"
                    aria-current="page">
                <span class="nav-icon" aria-hidden="true">&#127968;</span>
                <span class="nav-label">Главная</span>
            </button>
            <button class="nav-btn" 
                    data-screen="analytics" 
                    onclick="switchScreen('analytics')"
                    aria-label="Аналитика">
                <span class="nav-icon" aria-hidden="true">&#128202;</span>
                <span class="nav-label">Аналитика</span>
            </button>
            <button class="nav-btn add-btn" 
                    onclick="openAddModal()"
                    aria-label="Добавить операцию">
                <span class="nav-icon" aria-hidden="true">&#10133;</span>
            </button>
            <button class="nav-btn" 
                    data-screen="history" 
                    onclick="switchScreen('history')"
                    aria-label="История">
                <span class="nav-icon" aria-hidden="true">&#128220;</span>
                <span class="nav-label">История</span>
            </button>
            <button class="nav-btn" 
                    data-screen="settings" 
                    onclick="switchScreen('settings')"
                    aria-label="Настройки">
                <span class="nav-icon" aria-hidden="true">&#9881;&#65039;</span>
                <span class="nav-label">Настройки</span>
            </button>
        </nav>
    </div>

    <!-- ADD MODAL -->
    <div id="add-modal" class="modal" role="dialog" aria-labelledby="add-modal-title" aria-modal="true">
        <div class="modal-content modal-bottom">
            <div class="modal-header">
                <h3 id="add-modal-title">Добавить</h3>
                <button class="modal-close" onclick="closeAddModal()" aria-label="Закрыть">
                    &#10005;
                </button>
            </div>
            
            <div class="modal-tabs" role="tablist">
                <button class="modal-tab active" 
                        data-tab="expense"
                        role="tab"
                        aria-selected="true"
                        aria-controls="expense-tab">
                    Расход
                </button>
                <button class="modal-tab" 
                        data-tab="income"
                        role="tab"
                        aria-selected="false"
                        aria-controls="income-tab">
                    Доход
                </button>
                <button class="modal-tab" 
                        data-tab="transfer"
                        role="tab"
                        aria-selected="false"
                        aria-controls="transfer-tab">
                    Перевод
                </button>
                <button class="modal-tab" 
                        data-tab="loan"
                        role="tab"
                        aria-selected="false"
                        aria-controls="loan-tab">
                    Кредит
                </button>
            </div>

            <!-- EXPENSE TAB -->
            <div class="tab-content active" id="expense-tab" role="tabpanel">
                <div class="categories-grid" id="expense-categories" role="group" aria-label="Категории расходов">
                    <!-- Динамический контент -->
                </div>
                <div class="amount-input">
                    <input type="number" 
                           id="expense-amount" 
                           placeholder="0.00" 
                           class="amount-field"
                           min="0"
                           step="0.01"
                           aria-label="Сумма расхода"
                           required>
                </div>
                <input type="text" 
                       id="expense-desc" 
                       placeholder="Описание (необязательно)" 
                       class="desc-input"
                       aria-label="Описание расхода">
                <input type="file" 
                       id="expense-receipt" 
                       accept="image/*" 
                       style="display:none"
                       aria-label="Загрузить чек">
                <button class="attach-btn" 
                        onclick="document.getElementById('expense-receipt').click()"
                        aria-label="Прикрепить чек">
                    &#128444;&#65039; Прикрепить чек
                </button>
                <div id="expense-receipt-preview" class="receipt-preview"></div>
                <button class="btn-primary btn-large" onclick="saveExpense()">
                    Сохранить
                </button>
            </div>

            <!-- INCOME TAB -->
            <div class="tab-content" id="income-tab" role="tabpanel">
                <div class="categories-grid" id="income-categories" role="group" aria-label="Категории доходов">
                    <!-- Динамический контент -->
                </div>
                <div class="amount-input">
                    <input type="number" 
                           id="income-amount" 
                           placeholder="0.00" 
                           class="amount-field"
                           min="0"
                           step="0.01"
                           aria-label="Сумма дохода"
                           required>
                </div>
                <input type="text" 
                       id="income-desc" 
                       placeholder="Описание" 
                       class="desc-input"
                       aria-label="Описание дохода">
                <button class="btn-primary btn-large" onclick="saveIncome()">
                    Сохранить
                </button>
            </div>

            <!-- TRANSFER TAB -->
            <div class="tab-content" id="transfer-tab" role="tabpanel">
                <select id="transfer-from" class="select-input" aria-label="Из категории">
                    <option>Из категории</option>
                </select>
                <select id="transfer-to" class="select-input" aria-label="В категорию">
                    <option>В категорию</option>
                </select>
                <div class="amount-input">
                    <input type="number" 
                           id="transfer-amount" 
                           placeholder="0.00" 
                           class="amount-field"
                           min="0"
                           step="0.01"
                           aria-label="Сумма перевода"
                           required>
                </div>
                <input type="text" 
                       id="transfer-desc" 
                       placeholder="Примечание" 
                       class="desc-input"
                       aria-label="Примечание к переводу">
                <button class="btn-primary btn-large" onclick="saveTransfer()">
                    Сохранить
                </button>
            </div>

            <!-- LOAN TAB -->
            <div class="tab-content" id="loan-tab" role="tabpanel">
                <input type="text" 
                       id="loan-name" 
                       placeholder="Название (кому/откуда)" 
                       class="desc-input"
                       aria-label="Название кредита"
                       required>
                <div class="amount-input">
                    <input type="number" 
                           id="loan-amount" 
                           placeholder="Сумма" 
                           class="amount-field"
                           min="0"
                           step="0.01"
                           aria-label="Сумма кредита"
                           required>
                </div>
                <input type="date" 
                       id="loan-date" 
                       class="desc-input"
                       aria-label="Дата кредита">
                <input type="number" 
                       id="loan-percent" 
                       placeholder="Процент (необязательно)" 
                       class="desc-input"
                       min="0"
                       step="0.01"
                       aria-label="Процент кредита">
                <button class="btn-primary btn-large" onclick="saveLoan()">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- VOICE INPUT MODAL -->
    <div id="voice-modal" class="modal" role="dialog" aria-labelledby="voice-modal-title" aria-modal="true">
        <div class="modal-content modal-center">
            <button class="modal-close" onclick="closeVoiceModal()" aria-label="Закрыть">
                &#10005;
            </button>
            <div class="voice-animation">
                <div class="voice-circle"></div>
                <div class="voice-icon" aria-hidden="true">&#127908;</div>
            </div>
            <h3 id="voice-status">Нажмите, чтобы говорить</h3>
            <p id="voice-text" aria-live="polite"></p>
            <button class="btn-primary" 
                    id="voice-btn" 
                    onclick="startVoiceRecognition()"
                    aria-label="Начать голосовой ввод">
                Начать
            </button>
        </div>
    </div>

    <!-- TRANSACTION DETAIL MODAL -->
    <div id="detail-modal" class="modal" role="dialog" aria-labelledby="detail-modal-title" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detail-modal-title">Детали операции</h3>
                <button class="modal-close" onclick="closeDetailModal()" aria-label="Закрыть">
                    &#10005;
                </button>
            </div>
            <div id="transaction-detail">
                <!-- Динамический контент -->
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</body>
<script>
let state = {
    user: {
        monthlyIncome: 0,
        currency: 'USD',
        language: 'ru',
        theme: 'dark',
        dailyLimit: 0
    },
    transactions: [],
    loans: [],
    categories: {
        // Expense categories
         // Expense categories
        food: { ru: 'Продукты', en: 'Groceries', tj: 'Маҳсулот', icon: '🛒', color: '#10b981' },
        transport: { ru: 'Транспорт', en: 'Transport', tj: 'Наклиёт', icon: '🚖', color: '#3b82f6' },
        restaurant: { ru: 'Кафе', en: 'Dining', tj: 'Хӯрок', icon: '🍔', color: '#f59e0b' },
        health: { ru: 'Здоровье', en: 'Health', tj: 'Саломатӣ', icon: '💊', color: '#ef4444' },
        clothes: { ru: 'Одежда', en: 'Clothes', tj: 'Либос', icon: '👕', color: '#8b5cf6' },
        entertainment: { ru: 'Развлечения', en: 'Entertainment', tj: 'Фароғат', icon: '🎮', color: '#ec4899' },
        bills: { ru: 'Коммуналка', en: 'Bills', tj: 'Коммуналка', icon: '💡', color: '#f97316' },
        other: { ru: 'Другое', en: 'Other', tj: 'Дигар', icon: '📦', color: '#6b7280' },
        // Income categories
        salary: { ru: 'Зарплата', en: 'Salary', tj: 'Музд', icon: '💼', color: '#10b981' },
        freelance: { ru: 'Фриланс', en: 'Freelance', tj: 'Фриланс', icon: '💻', color: '#3b82f6' },
        gift: { ru: 'Подарок', en: 'Gift', tj: 'Туҳфа', icon: '🎁', color: '#ec4899' },
        investment: { ru: 'Инвестиции', en: 'Investment', tj: 'Сармоягузорӣ', icon: '📈', color: '#10b981' }
    },
    filters: {
        searchQuery: '',
        type: 'all',
        category: 'all',
        period: 'month'
    },
    settings: {
        notifications: {
            budget: true,
            debt: true,
            weekly: false,
            monthly: false
        }
    },
    currentScreen: 'home',
    editingTransaction: null,
    isFirstLaunch: true
};

// Currency rates
const rates = {
    USD: 1,
    TJS: 10.7,
    RUB: 92
};

// Translations
const translations = {
    ru: {
        greeting: ['Доброе утро', 'Добрый день', 'Добрый вечер'],
        months: ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'],
        days: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
        today: 'Сегодня',
        yesterday: 'Вчера',
        week: 'Неделя',
        month: 'Месяц',
        year: 'Год',
        all: 'Всё время',
        noData: 'Нет данных',
        confirmDelete: 'Удалить операцию?',
        confirmClear: 'Удалить все данные?',
        success: 'Успешно сохранено',
        error: 'Ошибка',
        fillFields: 'Заполните все поля'
    },
    en: {
        greeting: ['Good morning', 'Good afternoon', 'Good evening'],
        months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
        today: 'Today',
        yesterday: 'Yesterday',
        week: 'Week',
        month: 'Month',
        year: 'Year',
        all: 'All time',
        noData: 'No data',
        confirmDelete: 'Delete transaction?',
        confirmClear: 'Clear all data?',
        success: 'Successfully saved',
        error: 'Error',
        fillFields: 'Fill all fields'
    },
    tj: {
        greeting: ['Субҳ ба хайр', 'Рӯз ба хайр', 'Шом ба хайр'],
        months: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
        days: ['Якшанбе', 'Душанбе', 'Сешанбе', 'Чоршанбе', 'Панҷшанбе', 'Ҷумъа', 'Шанбе'],
        today: 'Имрӯз',
        yesterday: 'Дирӯз',
        week: 'Ҳафта',
        month: 'Моҳ',
        year: 'Сол',
        all: 'Ҳама вақт',
        noData: 'Маълумот нест',
        confirmDelete: 'Нест кунед?',
        confirmClear: 'Ҳамаро нест кунед?',
        success: 'Муваффақият',
        error: 'Хатогӣ',
        fillFields: 'Ҳамаро пур кунед'
    }
};

// Charts
let lineChart = null;
let pieChart = null;

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    initializeApp();
    setupEventListeners();
});

function initializeApp() {
    if (state.isFirstLaunch) {
        showOnboarding();
    } else {
        document.getElementById('onboarding').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        updateUI();
        renderAllScreens();
    }
}

// ==================== DATA PERSISTENCE ====================
function loadData() {
    try {
        const saved = localStorage.getItem('voicetifi_mobile');
        if (saved) {
            const parsed = JSON.parse(saved);
            state = { ...state, ...parsed };
            state.isFirstLaunch = false;
        }
    } catch (e) {
        console.error('Load error:', e);
    }
}

function saveData() {
    try {
        localStorage.setItem('voicetifi_mobile', JSON.stringify(state));
    } catch (e) {
        console.error('Save error:', e);
    }
}

// ==================== ONBOARDING ====================
let currentOnboardingStep = 1;

function showOnboarding() {
    document.getElementById('onboarding').classList.add('active');
    document.getElementById('app').style.display = 'none';
}

function nextOnboardingStep() {
    const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`);
    
    if (currentOnboardingStep === 2) {
        const income = parseFloat(document.getElementById('monthly-income').value);
        if (!income || income <= 0) {
            showToast(translations[state.user.language].fillFields, 'error');
            return;
        }
        state.user.monthlyIncome = income;
        state.user.dailyLimit = income / 30;
    }
    
    currentStepEl.classList.remove('active');
    currentOnboardingStep++;
    
    const nextStepEl = document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`);
    if (nextStepEl) {
        nextStepEl.classList.add('active');
    }
}

function finishOnboarding() {
    state.isFirstLaunch = false;
    saveData();
    
    document.getElementById('onboarding').classList.remove('active');
    document.getElementById('app').style.display = 'block';
    
    updateUI();
    renderAllScreens();
    
    showToast('Добро пожаловать в VoiseTiFi! 🎉', 'success');
}

// ==================== NAVIGATION ====================
function switchScreen(screenName) {
    // Hide all screens
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    // Show selected screen
    document.getElementById(`${screenName}-screen`).classList.add('active');
    document.querySelector(`.nav-btn[data-screen="${screenName}"]`)?.classList.add('active');
    
    state.currentScreen = screenName;
    
    // Render screen content
    if (screenName === 'home') renderHomeScreen();
    if (screenName === 'analytics') renderAnalyticsScreen();
    if (screenName === 'history') renderHistoryScreen();
    if (screenName === 'settings') renderSettingsScreen();
}

// ==================== HOME SCREEN ====================
function renderHomeScreen() {
    updateGreeting();
    updateBalanceCard();
    updateQuickStats();
    updateRecentTransactions();
    checkAlerts();
}

function updateGreeting() {
    const hour = new Date().getHours();
    const lang = state.user.language;
    let greetingIndex = 1; // afternoon
    if (hour < 12) greetingIndex = 0; // morning
    if (hour >= 18) greetingIndex = 2; // evening
    
    document.getElementById('greeting-text').textContent = translations[lang].greeting[greetingIndex];
    
    const date = new Date();
    const dayName = translations[lang].days[date.getDay()];
    const day = date.getDate();
    const month = translations[lang].months[date.getMonth()];
    document.getElementById('current-date').textContent = `${dayName}, ${day} ${month}`;
}

function updateBalanceCard() {
    const rate = rates[state.user.currency];
    const budget = state.user.monthlyIncome * rate;
    
    const expenses = getFilteredTransactions('expense', 'month');
    const totalExpense = expenses.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const income = getFilteredTransactions('income', 'month');
    const totalIncome = income.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const balance = budget - totalExpense;
    const spentPercent = budget > 0 ? Math.min((totalExpense / budget) * 100, 100) : 0;
    
    document.getElementById('total-balance').textContent = formatCurrency(balance);
    document.getElementById('total-income').textContent = '+' + formatCurrency(totalIncome);
    document.getElementById('total-expense').textContent = '-' + formatCurrency(totalExpense);
    document.getElementById('budget-progress').style.width = spentPercent + '%';
    document.getElementById('spent-percent').textContent = Math.round(spentPercent) + '%';
}

function updateQuickStats() {
    const rate = rates[state.user.currency];
    
    const today = getFilteredTransactions('expense', 'today');
    const todayTotal = today.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const week = getFilteredTransactions('expense', 'week');
    const weekTotal = week.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const month = getFilteredTransactions('expense', 'month');
    const monthTotal = month.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    document.getElementById('today-spent').textContent = '-' + formatCurrency(todayTotal);
    document.getElementById('week-spent').textContent = '-' + formatCurrency(weekTotal);
    document.getElementById('month-spent').textContent = '-' + formatCurrency(monthTotal);
}

function updateRecentTransactions() {
    const container = document.getElementById('recent-transactions');
    const recent = state.transactions.slice(0, 5);
    
    if (recent.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📄</div>
                <div class="empty-state-text">${translations[state.user.language].noData}</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recent.map(t => createTransactionHTML(t)).join('');
}

function checkAlerts() {
    const container = document.getElementById('alerts-container');
    const alerts = [];
    
    const rate = rates[state.user.currency];
    const budget = state.user.monthlyIncome * rate;
    const expenses = getFilteredTransactions('expense', 'month');
    const totalExpense = expenses.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    // Budget alert
     if (totalExpense > budget * 0.9) {
        alerts.push({
            type: 'warning',
            icon: '⚠️',
            title: 'Превышение бюджета',
            text: `Вы потратили ${Math.round((totalExpense/budget)*100)}% от бюджета`
        });
    }
    
    // Loans alert
    if (state.loans.length > 0) {
        alerts.push({
            type: 'info',
            icon: '💳',
            title: 'Активные долги',
            text: `У вас ${state.loans.length} непогашенных долгов`
        });
    }
    
    container.innerHTML = alerts.map(a => `
        <div class="alert ${a.type}">
            <div class="alert-icon">${a.icon}</div>
            <div class="alert-content">
                <div class="alert-title">${a.title}</div>
                <div class="alert-text">${a.text}</div>
            </div>
        </div>
    `).join('');
}

// ==================== ANALYTICS SCREEN ====================
function renderAnalyticsScreen() {
    updateAnalyticsCards();
    renderLineChart();
    renderPieChart();
    renderTopCategories();
    renderComparison();
    renderCalendarHeatmap();
}

function updateAnalyticsCards() {
    const period = state.filters.period;
    const rate = rates[state.user.currency];
    
    const expenses = getFilteredTransactions('expense', period);
    const totalExpense = expenses.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const income = getFilteredTransactions('income', period);
    const totalIncome = income.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const balance = totalIncome - totalExpense;
    const avgDaily = totalExpense / getDaysInPeriod(period);
    
    document.getElementById('analytics-income').textContent = '+' + formatCurrency(totalIncome);
    document.getElementById('analytics-expense').textContent = '-' + formatCurrency(totalExpense);
    document.getElementById('analytics-balance').textContent = formatCurrency(balance);
    document.getElementById('analytics-daily').textContent = '-' + formatCurrency(avgDaily);
}


function renderLineChart() {
    const canvas = document.getElementById('line-chart');
    const ctx = canvas.getContext('2d');
    
    if (lineChart) {
        lineChart.destroy();
        lineChart = null;
    }
    
    const period = state.filters.period;
    const data = getChartData(period);
    
    // Проверка на пустые данные
    if (data.values.length === 0) {
        canvas.parentElement.innerHTML = `
            <h3>Динамика расходов</h3>
            <div class="empty-state">
                <div class="empty-state-icon">📈</div>
                <div class="empty-state-text">${translations[state.user.language].noData}</div>
            </div>
        `;
        return;
    }
    
    lineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Расходы',
                data: data.values,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: (context) => formatCurrency(context.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { 
                        color: '#a0a0c0',
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#a0a0c0' }
                }
            }
        }
    });
}
function renderTopCategories() {
    const container = document.getElementById('top-categories');
    const period = state.filters.period;
    const expenses = getFilteredTransactions('expense', period);
    const rate = rates[state.user.currency];
    
    const categoryData = {};
    expenses.forEach(t => {
        if (!categoryData[t.category]) {
            categoryData[t.category] = 0;
        }
        categoryData[t.category] += t.amount * rate;
    });
    
    const sorted = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    const max = sorted[0]?.[1] || 1;
    
    container.innerHTML = sorted.map(([cat, amount]) => {
        const c = state.categories[cat] || state.categories.other;
        const percent = (amount / max) * 100;
        
        return `
            <div class="category-bar">
                <div class="category-bar-header">
                    <span class="category-bar-name">${c.icon} ${c[state.user.language]}</span>
                    <span class="category-bar-value">${formatCurrency(amount)}</span>
                </div>
                <div class="category-bar-progress">
                    <div class="category-bar-fill" style="width: ${percent}%; background: ${c.color};"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderPieChart() {
    const canvas = document.getElementById('pie-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // Уничтожаем старую диаграмму (если есть)
    if (pieChart) {
        pieChart.destroy();
        pieChart = null;
    }

    const period = state.filters.period;
    const expenses = getFilteredTransactions('expense', period);
    const rate = rates[state.user.currency];

    // Собираем суммы по категориям
    const categoryData = {};
    expenses.forEach(t => {
        const cat = t.category || 'other';
        categoryData[cat] = (categoryData[cat] || 0) + t.amount * rate;
    });

    const entries = Object.entries(categoryData).filter(([, v]) => v > 0);
    if (entries.length === 0) {
        const parent = canvas.parentElement;
        parent.innerHTML = `
            <h3>Структура расходов</h3>
            <div class="empty-state">
                <div class="empty-state-icon">🥧</div>
                <div class="empty-state-text">${translations[state.user.language].noData}</div>
            </div>
        `;
        return;
    }

    const labels = entries.map(([cat]) => (state.categories[cat]?.[state.user.language] || state.categories.other[state.user.language]));
    const values = entries.map(([, amt]) => amt);
    const bgColors = entries.map(([cat]) => (state.categories[cat]?.color || '#6b7280'));

    pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: bgColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#a0a0c0' }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const label = context.label || '';
                            const value = context.parsed;
                            const percent = ((value / values.reduce((s, n) => s + n, 0)) * 100).toFixed(1);
                            return `${label}: ${formatCurrency(value)} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
}


function renderComparison() {
    // Placeholder - can be expanded
}

function renderCalendarHeatmap() {
    const container = document.getElementById('calendar-heatmap');
    const today = new Date();
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const rate = rates[state.user.currency];
    
    const dailyExpenses = {};
    state.transactions.filter(t => t.type === 'expense').forEach(t => {
        const date = new Date(t.timestamp);
        if (date.getMonth() === today.getMonth()) {
            const day = date.getDate();
            if (!dailyExpenses[day]) dailyExpenses[day] = 0;
            dailyExpenses[day] += t.amount * rate;
        }
    });
    
    const maxExpense = Math.max(...Object.values(dailyExpenses), 1);
    
    let html = '';
    for (let i = 1; i <= daysInMonth; i++) {
        const expense = dailyExpenses[i] || 0;
        const intensity = expense / maxExpense;
        let bgColor = 'rgba(102, 126, 234, 0.1)';
        
        if (intensity > 0) {
            bgColor = `rgba(102, 126, 234, ${0.2 + intensity * 0.8})`;
        }
        
        html += `
            <div class="calendar-day" style="background: ${bgColor};" title="${i}: ${formatCurrency(expense)}">
                ${i}
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// ==================== HISTORY SCREEN ====================
function renderHistoryScreen() {
    renderTransactionsList();
    updatePeriodTotals();
}

function renderTransactionsList() {
    const container = document.getElementById('transactions-list');
    let filtered = [...state.transactions];
    
    // Apply filters
    if (state.filters.searchQuery) {
        filtered = filtered.filter(t => 
            t.description.toLowerCase().includes(state.filters.searchQuery.toLowerCase())
        );
    }
    
    if (state.filters.type !== 'all') {
        filtered = filtered.filter(t => t.type === state.filters.type);
    }
    
    if (state.filters.category !== 'all') {
        filtered = filtered.filter(t => t.category === state.filters.category);
    }
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-chart-pie"></i></div>
                <div class="empty-state-text">${translations[state.user.language].noData}</div>
            </div>
        `;
        return;
    }
    
    // Group by date
    const grouped = {};
    filtered.forEach(t => {
        const date = new Date(t.timestamp);
        const key = date.toDateString();
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
    });
    
    container.innerHTML = Object.entries(grouped).map(([date, transactions]) => {
        const dateLabel = getDateLabel(new Date(date));
        return `
            <div class="transaction-group">
                <div class="transaction-date-header">${dateLabel}</div>
                ${transactions.map(t => createTransactionHTML(t)).join('')}
            </div>
        `;
    }).join('');
}

function updatePeriodTotals() {
    const rate = rates[state.user.currency];
    
    const income = getFilteredTransactions('income', 'month');
    const totalIncome = income.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const expenses = getFilteredTransactions('expense', 'month');
    const totalExpense = expenses.reduce((sum, t) => sum + (t.amount * rate), 0);
    
    const balance = totalIncome - totalExpense;
    
    document.getElementById('period-income').textContent = '+' + formatCurrency(totalIncome);
    document.getElementById('period-expenses').textContent = '-' + formatCurrency(totalExpense);
    document.getElementById('period-balance').textContent = formatCurrency(balance);
}

// ==================== SETTINGS SCREEN ====================
function renderSettingsScreen() {
    document.getElementById('settings-income').textContent = formatCurrency(state.user.monthlyIncome * rates[state.user.currency]);
    document.getElementById('daily-limit').textContent = formatCurrency(state.user.dailyLimit * rates[state.user.currency]);
    
    const langMap = { ru: 'Русский', en: 'English', tj: 'Тоҷикӣ' };
    document.getElementById('current-language').textContent = langMap[state.user.language];
    
    const currMap = { USD: 'USD $', TJS: 'TJS SM', RUB: 'RUB ₽' };
    document.getElementById('current-currency').textContent = currMap[state.user.currency];
    
    document.getElementById('dark-theme').checked = state.user.theme === 'dark';
}

// ==================== ADD MODAL ====================
function openAddModal() {
    const modal = document.getElementById('add-modal');
    modal.classList.add('active');
    renderCategoriesGrid();
}

function closeAddModal() {
    document.getElementById('add-modal').classList.remove('active');
    clearAddForm();
}

function renderCategoriesGrid() {
    const expenseContainer = document.getElementById('expense-categories');
    const incomeContainer = document.getElementById('income-categories');
    
    const expenseCats = ['food', 'transport', 'restaurant', 'health', 'clothes', 'entertainment', 'bills', 'other'];
    const incomeCats = ['salary', 'freelance', 'gift', 'investment'];
    
    expenseContainer.innerHTML = expenseCats.map(cat => {
        const c = state.categories[cat];
        return `
            <div class="category-item" onclick="selectCategory('${cat}', 'expense')">
                <div class="category-icon">${c.icon}</div>
                <div class="category-label">${c[state.user.language]}</div>
            </div>
        `;
    }).join('');
    
    incomeContainer.innerHTML = incomeCats.map(cat => {
        const c = state.categories[cat];
        return `
            <div class="category-item" onclick="selectCategory('${cat}', 'income')">
                <div class="category-icon">${c.icon}</div>
                <div class="category-label">${c[state.user.language]}</div>
            </div>
        `;
    }).join('');
}

let selectedCategory = null;

function selectCategory(cat, type) {
    selectedCategory = cat;
    const container = document.getElementById(`${type}-categories`);
    container.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
    event.target.closest('.category-item').classList.add('active');
}

function saveExpense() {
    const amount = parseFloat(document.getElementById('expense-amount').value);
    const desc = document.getElementById('expense-desc').value.trim() || state.categories[selectedCategory]?.[state.user.language] || 'Расход';
    
    if (!selectedCategory || !amount || amount <= 0) {
        showToast(translations[state.user.language].fillFields, 'error');
        return;
    }
    
    const receipt = document.getElementById('expense-receipt-preview').innerHTML ? 
        document.querySelector('#expense-receipt-preview img')?.src : null;
    
    addTransaction('expense', selectedCategory, amount / rates[state.user.currency], desc, receipt);
    closeAddModal();
    showToast(translations[state.user.language].success, 'success');
}

function saveIncome() {
    const amount = parseFloat(document.getElementById('income-amount').value);
    const desc = document.getElementById('income-desc').value.trim() || state.categories[selectedCategory]?.[state.user.language] || 'Доход';
    
    if (!selectedCategory || !amount || amount <= 0) {
        showToast(translations[state.user.language].fillFields, 'error');
        return;
    }
    
    addTransaction('income', selectedCategory, amount / rates[state.user.currency], desc);
    closeAddModal();
    showToast(translations[state.user.language].success, 'success');
}

function saveTransfer() {
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const desc = document.getElementById('transfer-desc').value.trim() || 'Перевод';
    
    if (!amount || amount <= 0) {
        showToast(translations[state.user.language].fillFields, 'error');
        return;
    }
    
    addTransaction('transfer', 'other', amount / rates[state.user.currency], desc);
    closeAddModal();
    showToast(translations[state.user.language].success, 'success');
}

function saveLoan() {
    const name = document.getElementById('loan-name').value.trim();
    const amount = parseFloat(document.getElementById('loan-amount').value);
    
    if (!name || !amount || amount <= 0) {
        showToast(translations[state.user.language].fillFields, 'error');
        return;
    }
    
    const loan = {
        id: Date.now(),
        name: name,
        amount: amount / rates[state.user.currency],
        date: document.getElementById('loan-date').value || new Date().toISOString().split('T')[0],
        percent: parseFloat(document.getElementById('loan-percent').value) || 0,
        timestamp: Date.now()
    };
    
    state.loans.push(loan);
    saveData();
    closeAddModal();
    showToast('Долг добавлен', 'success');
}

function clearAddForm() {
    document.getElementById('expense-amount').value = '';
    document.getElementById('expense-desc').value = '';
    document.getElementById('income-amount').value = '';
    document.getElementById('income-desc').value = '';
    document.getElementById('transfer-amount').value = '';
    document.getElementById('transfer-desc').value = '';
    document.getElementById('loan-name').value = '';
    document.getElementById('loan-amount').value = '';
    document.getElementById('loan-date').value = '';
    document.getElementById('loan-percent').value = '';
    document.getElementById('expense-receipt-preview').innerHTML = '';
    selectedCategory = null;
}

// ==================== TRANSACTIONS ====================
function addTransaction(type, category, amount, description, receipt = null) {
    const transaction = {
        id: Date.now(),
        type: type,
        category: category,
        amount: amount, // stored in USD
        description: description,
        receipt: receipt,
        timestamp: Date.now()
    };
    
    state.transactions.unshift(transaction);
    saveData();
    updateUI();
}

function deleteTransaction(id) {
    if (confirm(translations[state.user.language].confirmDelete)) {
        state.transactions = state.transactions.filter(t => t.id !== id);
        saveData();
        updateUI();
        showToast('Удалено', 'success');
    }
}

function createTransactionHTML(transaction) {
    const rate = rates[state.user.currency];
    const category = state.categories[transaction.category] || state.categories.other;
    const amount = transaction.amount * rate;
    const isIncome = transaction.type === 'income';
    const amountClass = isIncome ? 'positive' : 'negative';
    const prefix = isIncome ? '+' : '-';
    
    const time = new Date(transaction.timestamp).toLocaleTimeString(state.user.language, {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    return `
        <div class="transaction-item" onclick="showTransactionDetail(${transaction.id})">
            <div class="transaction-icon" style="background: ${category.color}">
                ${category.icon}
            </div>
            <div class="transaction-info">
                <div class="transaction-title">${transaction.description}</div>
                <div class="transaction-time">${time}</div>
            </div>
            ${transaction.receipt ? `<img src="${transaction.receipt}" class="transaction-receipt" alt="Receipt">` : ''}
            <div class="transaction-amount ${amountClass}">
                ${prefix}${formatCurrency(amount)}
            </div>
        </div>
    `;
}

function showTransactionDetail(id) {
    const transaction = state.transactions.find(t => t.id === id);
    if (!transaction) return;
    
    const modal = document.getElementById('detail-modal');
    const container = document.getElementById('transaction-detail');
    const rate = rates[state.user.currency];
    const category = state.categories[transaction.category] || state.categories.other;
    const amount = transaction.amount * rate;
    const isIncome = transaction.type === 'income';
    const prefix = isIncome ? '+' : '-';
    
    const date = new Date(transaction.timestamp);
    const dateStr = date.toLocaleDateString(state.user.language, {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 64px; margin-bottom: 16px;">${category.icon}</div>
            <h3 style="font-size: 24px; margin-bottom: 8px;">${transaction.description}</h3>
            <div style="font-size: 36px; font-weight: 800; color: ${isIncome ? '#10b981' : '#ef4444'};">
                ${prefix}${formatCurrency(amount)}
            </div>
        </div>
        
        <div style="background: var(--bg-glass); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <span style="color: var(--text-secondary);">Категория</span>
                <span style="font-weight: 600;">${category[state.user.language]}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <span style="color: var(--text-secondary);">Дата</span>
                <span style="font-weight: 600;">${dateStr}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Тип</span>
                <span style="font-weight: 600;">${isIncome ? 'Доход' : 'Расход'}</span>
            </div>
        </div>
        
        ${transaction.receipt ? `
            <div style="margin-bottom: 16px;">
                <img src="${transaction.receipt}" style="width: 100%; border-radius: 12px;" alt="Receipt">
            </div>
        ` : ''}
        
        <div style="display: flex; gap: 12px;">
            <button class="btn-primary" style="flex: 1; background: var(--gradient-danger);" onclick="deleteTransaction(${transaction.id}); closeDetailModal();">
                🗑️ Удалить
            </button>
            <button class="btn-primary" style="flex: 1;" onclick="closeDetailModal()">
                Закрыть
            </button>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeDetailModal() {
    document.getElementById('detail-modal').classList.remove('active');
}

// ==================== VOICE INPUT ====================
let recognition = null;

function openVoiceInput() {
    const modal = document.getElementById('voice-modal');
    modal.classList.add('active');
    
    // Check for speech recognition support
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        document.getElementById('voice-status').textContent = 'Голосовой ввод не поддерживается';
        return;
    }
}

function closeVoiceModal() {
    document.getElementById('voice-modal').classList.remove('active');
    if (recognition) {
        recognition.stop();
    }
}

function startVoiceRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    recognition.lang = state.user.language === 'ru' ? 'ru-RU' : state.user.language === 'en' ? 'en-US' : 'ru-RU';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onstart = () => {
        document.getElementById('voice-status').textContent = 'Слушаю... Говорите';
        document.getElementById('voice-btn').textContent = '🎤 Слушаю...';
    };
    
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('voice-text').textContent = transcript;
        parseVoiceInput(transcript);
    };
    
    recognition.onerror = () => {
        document.getElementById('voice-status').textContent = 'Ошибка распознавания';
        document.getElementById('voice-btn').textContent = 'Повторить';
    };
    
    recognition.onend = () => {
        document.getElementById('voice-btn').textContent = 'Начать';
    };
    
    recognition.start();
}

function parseVoiceInput(text) {
    text = text.toLowerCase();
    
    // Extract amount
    const amountMatch = text.match(/(\d+(?:[.,]\d+)?)/);
    if (!amountMatch) {
        showToast('Не удалось распознать сумму', 'error');
        return;
    }
    
    const amount = parseFloat(amountMatch[0].replace(',', '.'));
    
    // Detect currency
    let currency = state.user.currency;
    if (text.includes('доллар') || text.includes('dollar')) currency = 'USD';
    else if (text.includes('рубл') || text.includes('ruble')) currency = 'RUB';
    else if (text.includes('сомон')) currency = 'TJS';
    
    const amountUSD = amount / rates[currency];
    
    // Detect type and category
    let type = 'expense';
    let category = 'other';
    
    const keywords = {
        income: ['доход', 'зарплата', 'получил', 'заработал', 'income', 'salary', 'earned'],
        food: ['хлеб', 'молоко', 'продукт', 'магазин', 'bread', 'milk', 'grocery', 'нон', 'ширу'],
        transport: ['такси', 'автобус', 'метро', 'taxi', 'bus', 'transport'],
        restaurant: ['кафе', 'ресторан', 'поел', 'cafe', 'restaurant', 'ate'],
        health: ['аптека', 'лекарство', 'врач', 'pharmacy', 'medicine', 'doctor'],
        clothes: ['одежда', 'купил футболку', 'clothes', 'shirt']
    };
    
    for (const [cat, words] of Object.entries(keywords)) {
        if (words.some(word => text.includes(word))) {
            if (cat === 'income') {
                type = 'income';
                category = 'salary';
            } else {
                category = cat;
            }
            break;
        }
    }
    
    // Create description
    let description = text.replace(amountMatch[0], '').replace(/доллар|dollar|рубл|ruble|сомон/gi, '').trim();
    if (!description) {
        const cat = state.categories[category];
        description = cat ? cat[state.user.language] : 'Операция';
    }
    
    addTransaction(type, category, amountUSD, description);
    
    setTimeout(() => {
        closeVoiceModal();
        showToast('Транзакция добавлена! 🎉', 'success');
    }, 1000);
}

// ==================== HELPER FUNCTIONS ====================
function getFilteredTransactions(type, period) {
    let filtered = state.transactions;
    
    if (type !== 'all') {
        filtered = filtered.filter(t => t.type === type);
    }
    
    if (period !== 'all') {
        const now = Date.now();
        const cutoffs = {
            today: now - 24 * 60 * 60 * 1000,
            week: now - 7 * 24 * 60 * 60 * 1000,
            month: now - 30 * 24 * 60 * 60 * 1000,
            year: now - 365 * 24 * 60 * 60 * 1000
        };
        
        if (cutoffs[period]) {
            filtered = filtered.filter(t => t.timestamp >= cutoffs[period]);
        }
    }
    
    return filtered;
}

function getDaysInPeriod(period) {
    const days = { today: 1, week: 7, month: 30, year: 365, all: 30 };
    return days[period] || 30;
}

function getChartData(period) {
    const days = getDaysInPeriod(period);
    const rate = rates[state.user.currency];
    const data = {};
    
    // Initialize days
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const key = date.toISOString().split('T')[0];
        data[key] = 0;
    }
    
    // Fill with expenses
    const expenses = getFilteredTransactions('expense', period);
    expenses.forEach(t => {
        const date = new Date(t.timestamp);
        const key = date.toISOString().split('T')[0];
        if (data.hasOwnProperty(key)) {
            data[key] += t.amount * rate;
        }
    });
    
    const labels = Object.keys(data).map(key => {
        const date = new Date(key);
        return date.toLocaleDateString(state.user.language, { month: 'short', day: 'numeric' });
    });
    
    return {
        labels: labels,
        values: Object.values(data)
    };
}

function getDateLabel(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const lang = state.user.language;
    
    if (date.toDateString() === today.toDateString()) {
        return translations[lang].today;
    } else if (date.toDateString() === yesterday.toDateString()) {
        return translations[lang].yesterday;
    } else {
        return date.toLocaleDateString(lang, { day: 'numeric', month: 'long' });
    }
}

function formatCurrency(amount) {
    const formatted = Math.abs(amount).toFixed(2);
    const symbol = state.user.currency === 'USD' ? '$' : (state.user.currency === 'RUB' ? '₽' : 'TJS');
    return `${formatted} ${symbol}`;
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        border-radius: 12px;
        font-weight: 600;
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function updateUI() {
    if (state.currentScreen === 'home') renderHomeScreen();
    if (state.currentScreen === 'analytics') renderAnalyticsScreen();
    if (state.currentScreen === 'history') renderHistoryScreen();
    if (state.currentScreen === 'settings') renderSettingsScreen();
}

function renderAllScreens() {
    renderHomeScreen();
    renderAnalyticsScreen();
    renderHistoryScreen();
    renderSettingsScreen();
}

// ==================== EVENT LISTENERS ====================
function setupEventListeners() {
    // Onboarding currency selection
    document.querySelectorAll('.currency-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            state.user.currency = this.dataset.currency;
        });
    });
    
    // Onboarding language selection
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            state.user.language = this.dataset.lang;
        });
    });
    
    // Period selector
    document.querySelectorAll('#period-tabs .period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#period-tabs .period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            state.filters.period = this.dataset.period;
            renderAnalyticsScreen();
        });
    });
    
    // Modal tabs
    document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(`${targetTab}-tab`).classList.add('active');
        });
    });
    
    // Search input
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            state.filters.searchQuery = this.value;
            renderHistoryScreen();
        });
    }
    
    // Type filter
    const typeFilter = document.getElementById('type-filter');
    if (typeFilter) {
        typeFilter.addEventListener('change', function() {
            state.filters.type = this.value;
            renderHistoryScreen();
        });
    }
    
    // Theme toggle
    const themeToggle = document.getElementById('dark-theme');
    if (themeToggle) {
        themeToggle.addEventListener('change', function() {
            state.user.theme = this.checked ? 'dark' : 'light';
            document.body.classList.toggle('light', !this.checked);
            saveData();
            
            // Re-render charts with new theme
            if (state.currentScreen === 'analytics') {
                renderAnalyticsScreen();
            }
        });
    }
    
    // Receipt upload for expense
    const receiptInput = document.getElementById('expense-receipt');
    if (receiptInput) {
        receiptInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Файл слишком большой (макс 5MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('expense-receipt-preview');
                    preview.innerHTML = `<img src="${event.target.result}" class="receipt-thumbnail" alt="Receipt">`;
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Close modals on background click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });
    
    // Import file
    const importFile = document.getElementById('import-file');
    if (importFile) {
        importFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const imported = JSON.parse(event.target.result);
                    state = { ...state, ...imported };
                    saveData();
                    updateUI();
                    showToast('Данные импортированы!', 'success');
                } catch (err) {
                    showToast('Ошибка импорта', 'error');
                }
            };
            reader.readAsText(file);
        });
    }
}

// ==================== ADDITIONAL FUNCTIONS ====================
function openAddWithReceipt() {
    openAddModal();
    setTimeout(() => {
        document.getElementById('expense-receipt').click();
    }, 300);
}

function openAddIncome() {
    openAddModal();
    setTimeout(() => {
        document.querySelectorAll('.modal-tab')[1].click();
    }, 100);
}

function openAddExpense() {
    openAddModal();
}

function editBudget() {
    const newBudget = prompt('Введите новый месячный бюджет:', state.user.monthlyIncome * rates[state.user.currency]);
    if (newBudget && !isNaN(newBudget) && parseFloat(newBudget) > 0) {
        state.user.monthlyIncome = parseFloat(newBudget) / rates[state.user.currency];
        state.user.dailyLimit = state.user.monthlyIncome / 30;
        saveData();
        updateUI();
        showToast('Бюджет обновлён!', 'success');
    }
}

function editMonthlyIncome() {
    editBudget();
}

function openLanguageSelector() {
    // Simple implementation - can be expanded to modal
    const langs = ['ru', 'en', 'tj'];
    const current = state.user.language;
    const currentIndex = langs.indexOf(current);
    const nextIndex = (currentIndex + 1) % langs.length;
    state.user.language = langs[nextIndex];
    saveData();
    updateUI();
    renderAllScreens();
}

function openCurrencySelector() {
    const currencies = ['USD', 'TJS', 'RUB'];
    const current = state.user.currency;
    const currentIndex = currencies.indexOf(current);
    const nextIndex = (currentIndex + 1) % currencies.length;
    state.user.currency = currencies[nextIndex];
    saveData();
    updateUI();
    renderAllScreens();
}

function manageCategories() {
    showToast('Функция в разработке', 'error');
}

function manageLoans() {
    showToast('Функция в разработке', 'error');
}

function manageRecurring() {
    showToast('Функция в разработке', 'error');
}

function manageGoals() {
    showToast('Функция в разработке', 'error');
}

function exportData() {
    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `voicetifi-backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Данные экспортированы!', 'success');
}

function importData() {
    document.getElementById('import-file').click();
}

function clearAllData() {
    if (confirm(translations[state.user.language].confirmClear)) {
        state.transactions = [];
        state.loans = [];
        saveData();
        updateUI();
        showToast('Все данные удалены', 'success');
    }
}

function showNotifications() {
    showToast('Нет новых уведомлений', 'success');
}

function openDateFilter() {
    showToast('Фильтр по дате в разработке', 'error');
}

function openAbout() {
    alert('VoiseTiFi v1.0.0\nУмное управление финансами\n\n© 2024');
}

// ==================== DEMO DATA ====================
function addDemoData() {
    if (state.transactions.length === 0) {
        // Add some demo transactions
        const demoTransactions = [
            { type: 'income', category: 'salary', amount: 3000, description: 'Зарплата', timestamp: Date.now() - 5 * 24 * 60 * 60 * 1000 },
            { type: 'expense', category: 'food', amount: 50, description: 'Продукты в магазине', timestamp: Date.now() - 4 * 24 * 60 * 60 * 1000 },
            { type: 'expense', category: 'transport', amount: 25, description: 'Такси до работы', timestamp: Date.now() - 3 * 24 * 60 * 60 * 1000 },
            { type: 'expense', category: 'restaurant', amount: 75, description: 'Ужин в ресторане', timestamp: Date.now() - 2 * 24 * 60 * 60 * 1000 },
            { type: 'expense', category: 'health', amount: 30, description: 'Аптека', timestamp: Date.now() - 1 * 24 * 60 * 60 * 1000 },
            { type: 'expense', category: 'entertainment', amount: 100, description: 'Кино и попкорн', timestamp: Date.now() }
        ];
        
        state.transactions = demoTransactions;
        saveData();
    }
}

// Add demo data on first launch for testing
if (state.isFirstLaunch && state.transactions.length === 0) {
    setTimeout(() => {
        if (!state.isFirstLaunch) {
            addDemoData();
            updateUI();
        }
    }, 2000);
}
</script>
</html>
